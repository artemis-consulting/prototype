{% extends "core/base.html" %}

{% load staticfiles %}
{% load url_tags %}
{% load humanize %}

{% block title %}
<title>FDA Drug Monitor - Enforcement Report Details</title>
{% endblock %}


{% block searchbar %}
    {% include 'core/searchbar.html' with search_category='enforcements'%}
{% endblock %}

{% block text %}
    <h1 class="page-title">Enforcement Report Details
        <br/>
        <small>Information for <strong>{{ q|replace_plus_signs }}</strong></small>
    </h1>
    <p class="page-description">
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec a magna ullamcorper, commodo nunc consectetur,
    pretium elit. Integer purus elit, commodo sed interdum in, aliquet sed erat. Donec quis quam vel massa
    consequat dictum eget in diam.
    </p>
{% endblock %}

{% block details %}
  <!-- Nav tabs -->
    <div id="fda-tabs-interface" class="fda-tabs-interface">
        <ul>
            <li><a href="#details">Details</a></li>
            <li><a href="#drugs">Drugs with enforcement reports in state</a></li>
        </ul>
        <!-- tab 1 -->
        <div id="details">
            {% include 'core/pagination.html' with result_list=enforcements result_paginator=enforcements_paginator %}

            <div class="fda-accordion-interface">
                <!-- accordion panel groups -->
                {% include 'core/tab_enforcements.html' with prefix='enforcements' %}
            </div>
        </div><!-- end tab 1 -->

        <!-- tab 2 -->
        <div id="drugs">
            <p>Click the chart below to visit the drug detail page</p>
                <div id="enforcementChart"></div><br/>
                <div id="productChart"></div><br/>
{#                {% for results in events %}<br />#}
{#                {% for key, value in results.items %}#}
{#                {{ key }}: {{ value }}<br />#}
{#                {% endfor %}#}
{#                {% endfor %}#}
        </div><!-- end tab 2 -->
    </div><!-- end panel -->

{% endblock %}

{% block extra_js %}
<script type="text/javascript">
(function($) {

    var drugNames = 
        [
        {% for results in drugs_count %}
        "{{ results.term }}",
        {% endfor %}
    ];

    var enforcementData = {
        name: 'Counts',
        // data points with extra properties:
        data: [
        {% for results in drugs_count %}
        {
            x: {{ forloop.counter0 }},
            y: {{ results.count }},
            url: "{% url 'search_labels' %}?q={{ results.term|replace_spaces|urlencode }}",
            investigation: true},
        {% endfor %}
        ]
    };

    function createEnforcementChart(categoryArray, seriesData) {
        $('#enforcementChart').highcharts({
            credits: {
                enabled: false
            },
            chart: {
                type: 'column'
            },
            title: {
                text: 'Drugs with Enforcement Reports in {{ q }}'
            },
            xAxis: {
                categories: categoryArray,
                crosshair: false,
                title: {
                    text: 'Drug name'
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of reports'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span>',
                pointFormat: '<div><span style="color:{series.color};">{series.name}</span>: <b>{point.y:.0f}</b></div>' +
                    '<div>Undergoing Investigation: <em>{point.investigation}</em></div>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                },
                series: {
                    point: {
                        events: {
                            click: function() {
                                location.href = this.options.url;
                            }
                        }
                    }
                }
            },
            series: [seriesData]
        });
    }

    function getDataAndCreateHyperlinks(productName) {

        $.getJSON("{% url 'search_detail' %}", {"browse_type": "enforcements", "q": "{{ q }}", "filter_string": productName})
            .fail(function() {
                console.log("error getting data");
            })
            .done(function(results) {
                console.log(results);
                createProductChart(productName, results);
            });
    }

    function createProductChart(productName, productDataArray) {
        $('#productChart').highcharts({
            credits: {
                enabled: false
            },
            chart: {
                type: 'column'
            },
            title: {
                text: productName+" effects grouped by sex"
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                categories: [
                    "0-100",
                ],
                crosshair: false
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of effects'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.0f}</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: productDataArray
        });
    }
    createEnforcementChart(drugNames, enforcementData);

})(jQuery);
</script>

{% endblock %}
